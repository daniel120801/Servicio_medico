<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información Básica de Salud</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-title {
            color: #0d6efd;
            margin-bottom: 25px;
            text-align: center;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .section-title {
            color: #0d6efd;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 5px;
        }
        
        .btn-submit {
            background-color: #0d6efd;
            color: white;
            padding: 10px 25px;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .btn-submit:hover {
            background-color: #0b5ed7;
        }
        
        .alert-success {
            margin-top: 20px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="form-container">
            <h2 class="form-title">Información Básica de Salud</h2>

            <!-- Mensaje de éxito (oculto inicialmente) -->
            <div id="success-message" class="alert alert-success d-none" role="alert">
                ¡Formulario enviado con éxito! Los datos han sido almacenados.
            </div>

            <!-- Mensaje de error (oculto inicialmente) -->
            <div id="error-message" class="alert alert-danger d-none" role="alert">
                Ha ocurrido un error al enviar el formulario.
            </div>

            <form id="health-form" action="API/medicalShift.php" method="POST">
                <input type="hidden" id="access_code" name="access_code" value="">
                <h5 class="section-title">Información Personal</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="fecha" class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="fecha" name="fecha" required>
                    </div>
                    <div class="col-md-8">
                        <label for="nombre" class="form-label">Nombre completo</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="direccion" class="form-label">Dirección y ciudad donde vive actualmente</label>
                    <input type="text" class="form-control" id="direccion" name="direccion" required>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="edad" class="form-label">Edad</label>
                        <input type="number" class="form-control" id="edad" name="edad" required>
                    </div>
                    <div class="col-md-3">
                        <label for="peso" class="form-label">Peso (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="peso" name="peso" required>
                    </div>
                    <div class="col-md-3">
                        <label for="estatura" class="form-label">Estatura (cm)</label>
                        <input type="number" class="form-control" id="estatura" name="estatura" required>
                    </div>
                    <div class="col-md-3">
                        <label for="sangre" class="form-label">Tipo de sangre</label>
                        <select class="form-select" id="sangre" name="sangre" required>
                            <option value="">Seleccionar</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="Desconocido">Desconocido</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="telefono" class="form-label">Telefono</label>
                        <input type="tel" class="form-control" id="telefono" name="telefono" required>
                        <div id="error-telefono" class="text-danger small"></div>
                    </div>
                    <div class="col-md-6">
                        <label for="correo" class="form-label">Correo electrónico</label>
                        <input type="email" class="form-control" id="correo" name="correo" required>
                        <div id="error-correo" class="text-danger small"></div>
                    </div>
                </div>

                <h5 class="section-title">Información Académica</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="carrera" class="form-label">Carrera</label>
                        <input type="text" class="form-control" id="carrera" name="carrera" required>
                    </div>
                    <div class="col-md-4">
                        <label for="grupo" class="form-label">Grupo</label>
                        <input type="text" class="form-control" id="grupo" name="grupo" required>
                    </div>
                    <div class="col-md-4">
                        <label for="seccion" class="form-label">Sección</label>
                        <input type="text" class="form-control" id="seccion" name="seccion" required>
                    </div>
                    <div class="col-md-6">
                        <label for="preparatoria" class="form-label">Preparatoria (de la que egresó)</label>
                        <input type="text" class="form-control" id="preparatoria" name="preparatoria" required>
                    </div>
                </div>


                <h5 class="section-title">Información de Salud</h5>
                <div class="mb-3">
                    <label for="enfermedades" class="form-label">Enfermedades actuales (crónicas y/o psicológicas)</label>
                    <textarea class="form-control" id="enfermedades" name="enfermedades" rows="2"></textarea>
                </div>

                <div class="mb-3">
                    <label for="tratamiento" class="form-label">¿Lleva algún tratamiento?</label>
                    <input type="text" class="form-control" id="tratamiento" name="tratamiento">
                </div>

                <div class="mb-3">
                    <label for="alergias" class="form-label">Alérgica a medicamentos, insectos o alimentos (explicar)</label>
                    <input type="text" class="form-control" id="alergias" name="alergias">
                </div>

                <div class="mb-3">
                    <label for="discapacidad" class="form-label">Discapacidad (explicar)</label>
                    <input type="text" class="form-control" id="discapacidad" name="discapacidad">
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="embarazo" class="form-label">¿Está embarazada?</label>
                        <select class="form-select" id="embarazo" name="embarazo">
                            <option value="">Seleccione</option>
                            <option value="Sí">Sí</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="semanas_embarazo" class="form-label">Semanas de embarazo</label>
                        <input type="number" class="form-control" id="semanas_embarazo" name="semanas_embarazo" disabled>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="imss" class="form-label">N° del IMSS</label>
                        <input type="text" class="form-control" id="imss" name="imss">
                    </div>
                    <div class="col-md-6">
                        <label for="afiliado_utnc" class="form-label">Afiliado por UTNC</label>
                        <select class="form-select" id="afiliado_utnc" name="afiliado_utnc">
                            <option value="">Seleccione</option>
                            <option value="Sí">Sí</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="curp" class="form-label">CURP</label>
                    <input type="text" class="form-control" id="curp" name="curp" required>
                    <div id="error-curp" class="text-danger small"></div>
                </div>

                <h5 class="section-title">Contacto de Emergencia</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="contacto" class="form-label">Nombre y parentesco</label>
                        <input type="text" class="form-control" id="contacto" name="contacto" required>
                    </div>
                    <div class="col-md-6">
                        <label for="contacto_cel" class="form-label">Teléfono de contacto</label>
                        <input type="tel" class="form-control" id="contacto_cel" name="contacto_cel" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="tutor" class="form-label">Nombre del tutor (si aplica)</label>
                    <input type="text" class="form-control" id="tutor" name="tutor">
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-submit" id="submit-button">
                        <span id="submit-text">Enviar Formulario</span>
                        <span id="loading-spinner" class="d-none"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Array para almacenar todos los formularios enviados (solo como respaldo)
        const formulariosEnviados = [];

        // Función para obtener el access_code de la URL
        function getAccessCodeFromURL() {
            const url = window.location.href;
            // Busca el access_code después del ? en la URL
            const match = url.match(/\?(\w{20,})/);
            return match ? match[1] : null;
        }

        // Verificar access_code en la base de datos
        async function verificarAccessCode(accessCode) {
            try {
                // Cambia la URL al endpoint que verifica el access_code
                const response = await fetch(`API/medicalShift.php?allheaders`, {
                    method: 'GET'
                });
                const result = await response.json();
                if (result.status === 'success' && Array.isArray(result.data)) {
                    // Buscar el access_code en los registros activos
                    const jornada = result.data.find(j => j.access_code === accessCode);
                    // Aquí podrías agregar más validaciones de "activo" si tienes ese campo
                    return !!jornada;
                }
                return false;
            } catch (e) {
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const accessCode = getAccessCodeFromURL();
            const formContainer = document.querySelector('.form-container');
            const healthForm = document.getElementById('health-form');
            const errorMessage = document.getElementById('error-message');

            if (!accessCode) {
                formContainer.style.display = 'none';
                errorMessage.textContent = 'No se encontró el código de acceso en la URL.';
                errorMessage.classList.remove('d-none');
                return;
            }

            // Verificar el access_code
            const valido = await verificarAccessCode(accessCode);
            if (!valido) {
                formContainer.style.display = 'none';
                errorMessage.textContent = 'El código de acceso no es válido o no está activo.';
                errorMessage.classList.remove('d-none');
                return;
            }

            // Si es válido, mostrar el formulario y establecer el access_code
            formContainer.style.display = '';
            document.getElementById('access_code').value = accessCode;

            // Establecer fecha actual por defecto
            const today = new Date();
            const yyyy = today.getFullYear();
            let mm = today.getMonth() + 1;
            let dd = today.getDate();

            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;

            const formattedToday = yyyy + '-' + mm + '-' + dd;
            document.getElementById('fecha').value = formattedToday;
        });

        // Habilitar campo de semanas de embarazo solo si está embarazada
        document.getElementById('embarazo').addEventListener('change', function() {
            const semanasEmbarazo = document.getElementById('semanas_embarazo');
            semanasEmbarazo.disabled = this.value !== 'Sí';
            if (this.value !== 'Sí') {
                semanasEmbarazo.value = '';
            }
        });

        // Validar CURP (acepta formato estándar y permite letras minúsculas)
        function validarCURP(curp) {
            // CURP estándar: 4 letras, 6 dígitos, 1 letra (H/M), 5 letras, 2 alfanuméricos
            const regex = /^[A-Za-z]{4}\d{6}[HhMm][A-Za-z]{5}[A-Za-z0-9]{2}$/;
            return regex.test(curp);
        }

        // Validar formulario antes de enviar y mostrar errores debajo de cada campo
        function validarFormulario(formData) {
            let valido = true;

            // Limpiar mensajes previos
            document.getElementById('error-curp').textContent = '';
            document.getElementById('error-correo').textContent = '';
            document.getElementById('error-telefono').textContent = '';

            // Validar CURP
            if (!validarCURP(formData.get('curp'))) {
                document.getElementById('error-curp').textContent = 'Por favor, ingrese una CURP válida.';
                valido = false;
            }

            // Validar email
            const email = formData.get('correo');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('error-correo').textContent = 'Por favor, ingrese un correo electrónico válido.';
                valido = false;
            }

            // Validar teléfono (mínimo 10 dígitos)
            const telefono = formData.get('telefono').replace(/\D/g, '');
            if (telefono.length < 10) {
                document.getElementById('error-telefono').textContent = 'Por favor, ingrese un número de teléfono válido (mínimo 10 dígitos).';
                valido = false;
            }

            return valido;
        }

        // Manejar el envío del formulario
        document.getElementById('health-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            // Obtener los datos del formulario
            const formData = new FormData(this);

            // Validar formulario
            if (!validarFormulario(formData)) {
                return;
            }

            // Mostrar estado de carga
            const submitText = document.getElementById('submit-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const submitButton = document.getElementById('submit-button');

            submitText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            loadingSpinner.classList.add('loading');
            submitButton.disabled = true;

            try {
                // Enviar datos al servidor al endpoint saveForm
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    // Guardar en el array de respaldo
                    const formObject = Object.fromEntries(formData.entries());
                    formulariosEnviados.push(formObject);
                    console.log('Formulario enviado:', formObject);
                    console.log('Todos los formularios:', formulariosEnviados);

                    // Mostrar mensaje de éxito
                    const successMessage = document.getElementById('success-message');
                    successMessage.classList.remove('d-none');
                    document.getElementById('error-message').classList.add('d-none');

                    // Ocultar mensaje después de 5 segundos
                    setTimeout(() => {
                        successMessage.classList.add('d-none');
                    }, 5000);

                    // Limpiar el formulario
                    this.reset();

                    // Restablecer fecha actual
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    let mm = today.getMonth() + 1;
                    let dd = today.getDate();

                    if (dd < 10) dd = '0' + dd;
                    if (mm < 10) mm = '0' + mm;

                    const formattedToday = yyyy + '-' + mm + '-' + dd;
                    document.getElementById('fecha').value = formattedToday;

                    // Deshabilitar semanas de embarazo nuevamente
                    document.getElementById('semanas_embarazo').disabled = true;
                } else {
                    throw new Error(result.message || result.error || 'Error al enviar el formulario');
                }
            } catch (error) {
                console.error('Error:', error);

                // Mostrar mensaje de error
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = error.message || 'Ha ocurrido un error al enviar el formulario.';
                errorMessage.classList.remove('d-none');
                document.getElementById('success-message').classList.add('d-none');
            } finally {
                // Ocultar estado de carga
                submitText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
                loadingSpinner.classList.remove('loading');
                submitButton.disabled = false;
            }
        });
    </script>
</body>

</html>